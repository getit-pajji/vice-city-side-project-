<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VICE CITY - E-Sports Tournaments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0c0a18; /* Deep space blue */
            color: #e0e0e0;
            overflow-x: hidden;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Starry Background Animation */
        .starry-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: #0c0a18;
        }
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 20% 30%, #fff, transparent),
                radial-gradient(1px 1px at 80% 10%, #fff, transparent),
                radial-gradient(1px 1px at 50% 70%, #fff, transparent),
                radial-gradient(2px 2px at 90% 40%, #fff, transparent),
                radial-gradient(2px 2px at 10% 90%, #fff, transparent),
                radial-gradient(2px 2px at 40% 50%, #fff, transparent);
            animation: twinkle 10s infinite linear;
        }
        @keyframes twinkle {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100vh); }
        }

        /* Flowing Glow Text Animation */
        .flow-glow-text {
            background: linear-gradient(90deg, #00ff9d, #00f2ff, #8a2be2, #ff00ff, #00ff9d);
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: flow-glow 10s linear infinite;
            text-shadow: 0 0 15px rgba(0, 255, 157, 0.5), 0 0 30px rgba(0, 242, 255, 0.3);
        }
        @keyframes flow-glow {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }
        
        .static-glow {
            font-weight: bold;
            color: #00ff9d;
            text-shadow: 0 0 8px rgba(0, 255, 157, 0.8), 0 0 12px rgba(0, 255, 157, 0.5);
        }

        /* Glass Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        }
        
        /* Chasing Glow Border Effect */
        .chasing-glow {
            position: relative;
            overflow: hidden;
        }
        .chasing-glow::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent,
                rgba(0, 255, 157, 0.5),
                transparent 30%
            );
            animation: rotate-glow 6s linear infinite;
            z-index: 1;
        }
        .chasing-glow > * {
            position: relative;
            z-index: 2;
        }

        @keyframes rotate-glow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Glowing Button */
        .btn-glow {
            transition: all 0.3s ease;
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.7), 0 0 30px rgba(0, 255, 157, 0.4);
            transform: scale(1.05);
        }
        
        /* Game Canvas */
        .game-canvas {
            background-color: #000;
            border-radius: 0.5rem;
            border: 2px solid #00ff9d;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.3), 0 0 30px rgba(0, 255, 157, 0.2);
            animation: glow-border 5s infinite alternate;
        }
        @keyframes glow-border {
            from { box-shadow: 0 0 15px rgba(0, 255, 157, 0.3), 0 0 30px rgba(0, 255, 157, 0.2); }
            to { box-shadow: 0 0 25px rgba(0, 242, 255, 0.5), 0 0 50px rgba(0, 242, 255, 0.3); }
        }
        
        .modal { display: none; }
        .modal.active { display: flex; }

        /* Leaderboard Rotator */
        #leaderboard-rotator {
            perspective: 1000px;
        }
        .leaderboard-card {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            transition: transform 0.6s ease;
        }
        .leaderboard-card.active {
            transform: rotateY(0deg);
        }

        /* Spinner for loading state */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #00ff9d;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        /* Radar Effect */
        .radar-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80vmin;
            height: 80vmin;
            max-width: 600px;
            max-height: 600px;
            z-index: -1;
            border-radius: 50%;
        }
        .radar-circle {
            position: absolute;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 157, 0.2);
            animation: radar-pulse 4s infinite ease-out;
        }
        .radar-circle:nth-child(1) { width: 25%; height: 25%; top: 37.5%; left: 37.5%; animation-delay: 0s; }
        .radar-circle:nth-child(2) { width: 50%; height: 50%; top: 25%; left: 25%; animation-delay: 1s; }
        .radar-circle:nth-child(3) { width: 75%; height: 75%; top: 12.5%; left: 12.5%; animation-delay: 2s; }
        .radar-circle:nth-child(4) { width: 100%; height: 100%; top: 0; left: 0; animation-delay: 3s; }

        @keyframes radar-pulse {
            0% { transform: scale(0.1); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        .radar-scanner {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: conic-gradient(transparent, transparent 270deg, rgba(0, 255, 157, 0.4), transparent);
            border-radius: 50%;
            animation: radar-scan 4s linear infinite;
        }
        @keyframes radar-scan {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="starry-background">
        <div class="stars"></div>
    </div>

    <!-- Header -->
    <header class="bg-black/30 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-orbitron font-bold tracking-widest flex items-center">
                <svg class="w-10 h-10 mr-3" style="filter: drop-shadow(0 0 8px #00ff9d);" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 95C35 95 25 85 25 70C25 55 35 45 50 45C65 45 75 55 75 70C75 85 65 95 50 95Z" fill="#32CD32"/>
                    <path d="M50 5C52.7614 5 55 7.23858 55 10V50C55 52.7614 52.7614 55 50 55C47.2386 55 45 52.7614 45 50V10C45 7.23858 47.2386 5 50 5Z" fill="#8B4513"/>
                    <g transform="rotate(45 50 10)"><path d="M50 10 C 70 10, 70 40, 50 40 C 30 40, 30 10, 50 10" fill="#228B22"/></g>
                    <g transform="rotate(-45 50 10)"><path d="M50 10 C 70 10, 70 40, 50 40 C 30 40, 30 10, 50 10" fill="#228B22"/></g>
                     <g transform="rotate(135 50 10)"><path d="M50 10 C 70 10, 70 40, 50 40 C 30 40, 30 10, 50 10" fill="#228B22"/></g>
                    <g transform="rotate(-135 50 10)"><path d="M50 10 C 70 10, 70 40, 50 40 C 30 40, 30 10, 50 10" fill="#228B22"/></g>
                </svg>
                VICE CITY
            </h1>
            <nav class="hidden md:flex space-x-8 font-semibold">
                <a href="#news" class="hover:text-cyan-400 transition-colors">News</a>
                <a href="#profile" class="hover:text-cyan-400 transition-colors">Player Profile</a>
                <a href="#tournaments" class="hover:text-cyan-400 transition-colors">Tournaments</a>
                <a href="#leaderboard" class="hover:text-cyan-400 transition-colors">Leaderboard</a>
                <a href="#arcade" class="hover:text-cyan-400 transition-colors">Arcade</a>
                <a href="#suggest" class="hover:text-cyan-400 transition-colors">Suggest</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="min-h-screen flex items-center justify-center text-center px-6 relative">
        <div class="radar-container">
            <div class="radar-circle"></div>
            <div class="radar-circle"></div>
            <div class="radar-circle"></div>
            <div class="radar-circle"></div>
            <div class="radar-scanner"></div>
        </div>
        <div class="relative z-10">
            <h2 class="text-6xl md:text-9xl font-orbitron font-black uppercase flow-glow-text">
                Dominate the Arena
            </h2>
            <p class="mt-6 text-lg md:text-xl text-gray-300 max-w-3xl mx-auto">
                Welcome to VICE CITY, the premier hub for competitive gaming. Join our tournaments, prove your skill, and claim your glory.
            </p>
            <div class="mt-10">
                <a href="#tournaments" class="bg-gradient-to-r from-green-400 to-cyan-500 text-gray-900 font-bold text-xl px-12 py-4 rounded-full btn-glow">
                    Browse Tournaments
                </a>
            </div>
        </div>
    </section>

    <!-- Latest News Section -->
    <section id="news" class="py-20 px-6">
        <div class="container mx-auto max-w-4xl text-center">
            <h2 class="text-4xl md:text-6xl font-orbitron font-bold mb-12">Latest News</h2>
            <div id="news-list" class="space-y-6">
                <!-- News items will be loaded here -->
                <p class="text-gray-400">Loading latest announcements...</p>
            </div>
        </div>
    </section>

    <!-- Player Profile Section -->
    <section id="profile" class="py-20 px-6">
        <div class="container mx-auto max-w-4xl text-center">
            <h2 class="text-4xl md:text-6xl font-orbitron font-bold">Create Your Player Profile</h2>
            <p class="mt-4 text-gray-400 max-w-2xl mx-auto">Create your profile once to make registering for any tournament a one-click process!</p>
            <form id="player-profile-form" class="glass-card rounded-2xl p-8 mt-10 text-left space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-300">Full Name</label>
                        <input type="text" id="profile-name" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    </div>
                    <div>
                        <label for="profile-phone" class="block text-sm font-medium text-gray-300">Phone Number (This is your unique ID)</label>
                        <input type="tel" id="profile-phone" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    </div>
                </div>
                <div>
                    <label for="profile-email" class="block text-sm font-medium text-gray-300">Email Address</label>
                    <input type="email" id="profile-email" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <h3 class="text-lg font-semibold border-t border-gray-700 pt-4">Your In-Game IDs</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="profile-bgmi" class="block text-sm font-medium text-gray-300">BGMI</label>
                        <input type="text" id="profile-bgmi" class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="Your BGMI ID">
                    </div>
                    <div>
                        <label for="profile-valorant" class="block text-sm font-medium text-gray-300">Valorant</label>
                        <input type="text" id="profile-valorant" class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="Riot ID#Tag">
                    </div>
                    <div>
                        <label for="profile-codm" class="block text-sm font-medium text-gray-300">CODM</label>
                        <input type="text" id="profile-codm" class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="Your CODM ID">
                    </div>
                    <div>
                        <label for="profile-freefire" class="block text-sm font-medium text-gray-300">Free Fire</label>
                        <input type="text" id="profile-freefire" class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="Your Free Fire ID">
                    </div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-cyan-500 text-gray-900 font-bold px-8 py-4 rounded-full btn-glow mt-6">Save Player Profile</button>
            </form>
        </div>
    </section>

    <!-- Upcoming Tournaments Section -->
    <section id="tournaments" class="py-20">
        <div class="container mx-auto px-6">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-6xl font-orbitron font-bold">Upcoming Tournaments</h2>
                <p class="mt-4 text-gray-400">Your next challenge awaits. Register now!</p>
            </div>
            <div id="tournaments-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Tournament cards will be dynamically inserted here -->
                <p class="col-span-full text-center text-gray-400">Loading upcoming events...</p>
            </div>
        </div>
    </section>

    <!-- Leaderboard Section -->
    <section id="leaderboard" class="py-20 px-6">
        <div class="container mx-auto max-w-4xl text-center">
            <h2 class="text-4xl md:text-6xl font-orbitron font-bold mb-12">Hall of Fame</h2>
            <div class="chasing-glow glass-card rounded-2xl p-1">
                <div class="bg-gray-900 rounded-xl p-8 relative">
                    <div id="leaderboard-rotator" class="relative h-96">
                        <!-- Leaderboard cards will be injected here -->
                    </div>
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-4">
                        <button id="prev-leaderboard" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition"><i class="fas fa-arrow-left"></i></button>
                        <button id="next-leaderboard" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Arcade Zone -->
    <section id="arcade" class="py-20 px-6">
        <div class="container mx-auto">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-6xl font-orbitron font-bold">Arcade Zone</h2>
                <p class="mt-4 text-gray-400">Don't get bored while waiting for the next tournament.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Space Shooter Game -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-3xl font-orbitron font-bold text-center mb-4">Starfire Shooter</h3>
                    <canvas id="spaceShooterCanvas" class="w-full h-auto aspect-video game-canvas cursor-none"></canvas>
                    <p class="text-center text-sm mt-4 text-gray-400">Move mouse/finger to control ship. Tap/Click to shoot.</p>
                </div>
                <!-- Retro Ping Game -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-3xl font-orbitron font-bold text-center mb-4">Retro Ping</h3>
                    <canvas id="pongCanvas" class="w-full h-auto aspect-video game-canvas cursor-pointer"></canvas>
                     <p class="text-center text-sm mt-4 text-gray-400">Move mouse/finger to control paddle. Tap/Click to start.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Suggest a Game Section -->
    <section id="suggest" class="py-20 px-6">
        <div class="container mx-auto max-w-3xl text-center">
            <h2 class="text-4xl md:text-6xl font-orbitron font-bold">Request a Game</h2>
            <p class="mt-4 text-gray-400">Don't see your favorite game? Tell us what to add next and we'll consider it for our next event!</p>
            <form id="suggestion-form" class="mt-10 flex flex-col sm:flex-row gap-4">
                <input type="text" placeholder="Enter game name (e.g., Apex Legends)" class="w-full bg-gray-800 border border-gray-700 rounded-full px-6 py-4 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400 transition">
                <button type="submit" class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold px-8 py-4 rounded-full btn-glow">Submit Idea</button>
            </form>
            <div id="suggestion-thanks" class="hidden mt-6 p-4 bg-green-500/20 text-green-300 rounded-lg">
                <p>Thanks for the suggestion! We'll look into it. 🔥</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black/30 border-t border-gray-800 py-8">
        <div class="container mx-auto text-center text-gray-400">
            <div class="mb-4">
                <a href="https://wa.me/919313011448" target="_blank" class="hover:text-cyan-400 transition-colors">
                    <i class="fab fa-whatsapp mr-2"></i>+91 9313011448
                </a>
            </div>
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-cyan-400"><i class="fab fa-twitter text-2xl"></i></a>
                <a href="#" class="hover:text-cyan-400"><i class="fab fa-instagram text-2xl"></i></a>
                <a href="#" class="hover:text-cyan-400"><i class="fab fa-discord text-2xl"></i></a>
                <a href="#" class="hover:text-cyan-400"><i class="fab fa-youtube text-2xl"></i></a>
            </div>
            <p class="text-sm mb-2">&copy; 2024 VICE CITY E-Sports. All Rights Reserved.</p>
            <p class="text-lg mt-4">Made by <span class="static-glow">GETIT</span></p>
        </div>
    </footer>

    <!-- Registration Modal -->
    <div id="registration-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 w-full max-w-md m-4">
            <h2 id="modal-title" class="text-3xl font-orbitron font-bold mb-6 text-center">Register for Tournament</h2>
            <form id="registration-form">
                <input type="hidden" id="tournament-id-input">
                <input type="hidden" id="tournament-game-name">
                <div class="space-y-4">
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-300">Your Phone Number</label>
                        <div class="flex gap-2 mt-1">
                            <input type="tel" id="phone" required class="block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <button type="button" id="load-profile-btn" class="bg-cyan-500/80 text-white font-bold px-4 rounded-lg hover:bg-cyan-500">Load</button>
                        </div>
                    </div>
                    <hr class="border-gray-700 my-4">
                    <div>
                        <label for="player-name" class="block text-sm font-medium text-gray-300">Your Full Name</label>
                        <input type="text" id="player-name" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300">Email Address</label>
                        <input type="email" id="email" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    </div>
                    <div>
                        <label for="gamer-tag" class="block text-sm font-medium text-gray-300">Your In-Game ID</label>
                        <input type="text" id="gamer-tag" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    </div>
                    <div class="relative">
                        <label for="team-name" class="block text-sm font-medium text-gray-300">Team Name</label>
                        <input type="text" id="team-name" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <button type="button" id="suggest-name-btn" class="absolute right-3 top-8 text-xs bg-cyan-500/20 text-cyan-300 font-semibold px-2 py-1 rounded hover:bg-cyan-500/40">✨ Suggest</button>
                    </div>
                     <div class="flex items-center">
                        <input type="checkbox" id="is-leader" class="h-4 w-4 bg-gray-800 border-gray-600 text-cyan-400 focus:ring-cyan-500 rounded">
                        <label for="is-leader" class="ml-2 block text-sm text-gray-300">I am the team leader</label>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancel-register-btn" class="bg-gray-600 text-white font-bold px-6 py-2 rounded-full hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="bg-gradient-to-r from-green-400 to-cyan-500 text-gray-900 font-bold px-6 py-2 rounded-full btn-glow">Submit Registration</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 w-full max-w-sm m-4 text-center">
            <p id="alert-message" class="text-lg mb-6"></p>
            <button id="alert-ok-btn" class="bg-gradient-to-r from-green-400 to-cyan-500 text-gray-900 font-bold px-8 py-2 rounded-full">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, serverTimestamp, runTransaction, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', function() {
            let db, auth, appId;

            // --- Firebase and Registration Logic ---
            async function main() {
                const firebaseConfig = {
                  apiKey: "AIzaSyCYusn8iUJhiQHKBKFnIgzo82pY4fXjc38",
                  authDomain: "meethe-275ef.firebaseapp.com",
                  projectId: "meethe-275ef",
                  storageBucket: "meethe-275ef.appspot.com",
                  messagingSenderId: "841227918612",
                  appId: "1:841227918612:web:715d9d6a3051a00a023601",
                  measurementId: "G-CX9SGS1K01"
                };
                appId = 'vice-city-esports';

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebase config is missing!");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User authenticated:", user.uid);
                        loadTournaments();
                        setupLeaderboard();
                        loadNews();
                    }
                });

                try {
                    if (!auth.currentUser) await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication failed:", error);
                }

                const registrationModal = document.getElementById('registration-modal');
                const registrationForm = document.getElementById('registration-form');
                const cancelRegisterBtn = document.getElementById('cancel-register-btn');
                const modalTitle = document.getElementById('modal-title');
                const tournamentIdInput = document.getElementById('tournament-id-input');
                const tournamentGameNameInput = document.getElementById('tournament-game-name');
                const suggestNameBtn = document.getElementById('suggest-name-btn');
                const tournamentsGrid = document.getElementById('tournaments-grid');
                const playerProfileForm = document.getElementById('player-profile-form');
                const loadProfileBtn = document.getElementById('load-profile-btn');
                const alertModal = document.getElementById('alert-modal');
                const alertMessage = document.getElementById('alert-message');
                const alertOkBtn = document.getElementById('alert-ok-btn');

                function showCustomAlert(message) {
                    alertMessage.textContent = message;
                    alertModal.classList.add('active');
                }
                alertOkBtn.addEventListener('click', () => alertModal.classList.remove('active'));

                tournamentsGrid.addEventListener('click', (e) => {
                    const button = e.target.closest('.register-btn');
                    if (button) {
                        const tournamentId = button.dataset.tournamentId;
                        const tournamentName = button.dataset.tournamentName;
                        const gameName = button.dataset.gameName;
                        modalTitle.textContent = `Register for ${tournamentName}`;
                        tournamentIdInput.value = tournamentId;
                        tournamentGameNameInput.value = gameName;
                        registrationModal.classList.add('active');
                    }
                });

                cancelRegisterBtn.addEventListener('click', () => {
                    registrationModal.classList.remove('active');
                });

                registrationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const tournamentId = tournamentIdInput.value;
                    const tournamentDocRef = doc(db, `/artifacts/${appId}/public/data/tournaments`, tournamentId);
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const tournamentDoc = await transaction.get(tournamentDocRef);
                            if (!tournamentDoc.exists()) throw "This tournament no longer exists.";

                            const currentSlots = tournamentDoc.data().registrationsCount || 0;
                            const totalSlots = tournamentDoc.data().totalSlots;
                            if (currentSlots >= totalSlots) throw "Sorry, this tournament is full!";

                            const registrationData = {
                                tournament: tournamentDoc.data().tournamentName,
                                teamName: document.getElementById('team-name').value,
                                playerName: document.getElementById('player-name').value,
                                gamerTag: document.getElementById('gamer-tag').value,
                                isLeader: document.getElementById('is-leader').checked,
                                email: document.getElementById('email').value,
                                phoneNumber: document.getElementById('phone').value,
                                paymentStatus: 'unpaid',
                                createdAt: serverTimestamp()
                            };
                            
                            const registrationsCollection = collection(db, `/artifacts/${appId}/public/data/tournaments/${tournamentId}/registrations`);
                            transaction.set(doc(registrationsCollection), registrationData);
                            transaction.update(tournamentDocRef, { registrationsCount: currentSlots + 1 });
                        });

                        showCustomAlert("Registration Confirmed! ✅\n\nYour spot is secured!");
                        registrationForm.reset();
                        registrationModal.classList.remove('active');

                    } catch (error) {
                        console.error("Error submitting registration: ", error);
                        showCustomAlert(`Registration failed: ${error}`);
                    }
                });

                playerProfileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const phone = document.getElementById('profile-phone').value.trim();
                    if (phone.length < 10) {
                        showCustomAlert("Please enter a valid 10-digit phone number.");
                        return;
                    }

                    const profileData = {
                        name: document.getElementById('profile-name').value,
                        email: document.getElementById('profile-email').value,
                        phone: phone,
                        gameIds: {
                            BGMI: document.getElementById('profile-bgmi').value,
                            Valorant: document.getElementById('profile-valorant').value,
                            CODM: document.getElementById('profile-codm').value,
                            "Free Fire": document.getElementById('profile-freefire').value,
                        }
                    };

                    try {
                        const playerDocRef = doc(db, `/artifacts/${appId}/public/data/players`, phone);
                        await setDoc(playerDocRef, profileData);
                        showCustomAlert("Player Profile Saved! You can now use your phone number to auto-fill registration forms.");
                        playerProfileForm.reset();
                    } catch (error) {
                        console.error("Error saving profile:", error);
                        showCustomAlert("Could not save your profile. Please try again.");
                    }
                });

                loadProfileBtn.addEventListener('click', async () => {
                    const phone = document.getElementById('phone').value.trim();
                    if (phone.length < 10) {
                        showCustomAlert("Please enter your phone number to load your profile.");
                        return;
                    }
                    
                    const playerDocRef = doc(db, `/artifacts/${appId}/public/data/players`, phone);
                    const docSnap = await getDoc(playerDocRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('player-name').value = data.name;
                        document.getElementById('email').value = data.email;
                        
                        const gameName = tournamentGameNameInput.value;
                        let gameId = '';
                        if (gameName.includes('BGMI')) gameId = data.gameIds.BGMI;
                        else if (gameName.includes('Valorant')) gameId = data.gameIds.Valorant;
                        else if (gameName.includes('CODM')) gameId = data.gameIds.CODM;
                        else if (gameName.includes('Free Fire')) gameId = data.gameIds["Free Fire"];
                        
                        document.getElementById('gamer-tag').value = gameId;
                        showCustomAlert("Profile loaded!");
                    } else {
                        showCustomAlert("No profile found for this phone number. Please create one first.");
                    }
                });

                suggestNameBtn.addEventListener('click', async () => {
                    const originalText = suggestNameBtn.innerHTML;
                    suggestNameBtn.innerHTML = `<span class="loader"></span>`;
                    suggestNameBtn.disabled = true;

                    const prompt = "Generate a cool, edgy, futuristic e-sports team name suitable for a tournament called VICE CITY. The name should be one or two words. Provide only the name, nothing else.";
                    const teamName = await callGeminiForText(prompt);

                    if (teamName) {
                        document.getElementById('team-name').value = teamName.trim().replace(/"/g, '');
                    } else {
                        showCustomAlert("Could not generate a name. Please try again.");
                    }

                    suggestNameBtn.innerHTML = '✨ Suggest';
                    suggestNameBtn.disabled = false;
                });
            }

            function loadTournaments() {
                 const tournamentsCollection = collection(db, `/artifacts/${appId}/public/data/tournaments`);
                 onSnapshot(tournamentsCollection, (snapshot) => {
                    const tournamentsGrid = document.getElementById('tournaments-grid');
                    tournamentsGrid.innerHTML = '';
                    if (snapshot.empty) {
                        tournamentsGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">No upcoming tournaments. Check back soon!</p>';
                        return;
                    }

                    const sortedDocs = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(t => t.status === 'upcoming' || t.status === 'live')
                        .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

                    if (sortedDocs.length === 0) {
                        tournamentsGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">No upcoming tournaments. Check back soon!</p>';
                        return;
                    }

                    sortedDocs.forEach(tournament => {
                        const card = document.createElement('div');
                        card.className = 'glass-card chasing-glow rounded-2xl p-1';
                        
                        const registrationsCount = tournament.registrationsCount || 0;
                        const slotsLeft = tournament.totalSlots - registrationsCount;
                        const isFull = slotsLeft <= 0;

                        card.innerHTML = `
                            <div class="bg-gray-900 rounded-xl p-6 h-full flex flex-col">
                                <h3 class="text-2xl font-orbitron font-bold text-white">${tournament.tournamentName}</h3>
                                <p class="text-cyan-400 font-semibold">${tournament.gameName}</p>
                                <p class="text-gray-300 mt-4"><i class="fas fa-calendar-alt mr-2"></i>${new Date(tournament.dateTime).toLocaleString()}</p>
                                <p class="text-gray-300"><i class="fas fa-trophy mr-2"></i>Prize: ₹${tournament.prizePool}</p>
                                <div class="mt-4 flex-grow"></div>
                                <div class="bg-black/30 p-3 rounded-lg text-center">
                                    <p class="font-bold text-lg">${slotsLeft} Slots Left</p>
                                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                                        <div class="bg-gradient-to-r from-green-400 to-cyan-500 h-2.5 rounded-full" style="width: ${ (registrationsCount / tournament.totalSlots) * 100}%"></div>
                                    </div>
                                </div>
                                <button class="register-btn mt-6 w-full font-bold py-3 px-6 rounded-full text-center transition-colors ${isFull ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-green-500 text-gray-900 hover:bg-green-400'}" data-tournament-id="${tournament.id}" data-tournament-name="${tournament.tournamentName}" data-game-name="${tournament.gameName}" ${isFull ? 'disabled' : ''}>
                                    ${isFull ? 'Slots Full' : 'Register Now'}
                                </button>
                            </div>
                        `;
                        tournamentsGrid.appendChild(card);
                    });
                 });
            }
            
            function loadNews() {
                const newsList = document.getElementById('news-list');
                const newsCollection = collection(db, `/artifacts/${appId}/public/data/news`);
                onSnapshot(newsCollection, (snapshot) => {
                    newsList.innerHTML = '';
                    if (snapshot.empty) {
                        newsList.innerHTML = '<p class="text-gray-400">No news yet. Stay tuned!</p>';
                        return;
                    }
                    const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0));
                    sortedDocs.forEach(doc => {
                        const news = doc.data();
                        const newsItem = document.createElement('div');
                        newsItem.className = 'glass-card p-6 rounded-lg text-left';
                        newsItem.innerHTML = `
                            <h3 class="text-2xl font-orbitron font-bold text-cyan-400">${news.title}</h3>
                            <p class="text-xs text-gray-500 mb-4">${news.createdAt?.toDate().toLocaleString()}</p>
                            <p class="text-gray-300">${news.content}</p>
                        `;
                        newsList.appendChild(newsItem);
                    });
                });
            }

            function setupLeaderboard() {
                const rotator = document.getElementById('leaderboard-rotator');
                const prevBtn = document.getElementById('prev-leaderboard');
                const nextBtn = document.getElementById('next-leaderboard');
                let leaderboards = {};
                let gameNames = [];
                let currentIndex = 0;

                const games = [
                    "BGMI Showdown", "Valorant Clash", "CODM Mobile Mayhem", 
                    "Free Fire Frenzy", "Smash Cart Grand Prix", "CS 2 Face-Off", "Fortnite Build Battle"
                ];

                games.forEach(game => {
                    const leaderboardDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboards`, game);
                    onSnapshot(leaderboardDocRef, (doc) => {
                        if (doc.exists() && doc.data().ranks && doc.data().ranks.length > 0) {
                            leaderboards[game] = doc.data().ranks.sort((a, b) => a.rank - b.rank);
                        } else {
                            leaderboards[game] = [{rank: 1, name: "TBD", achievement: "Top Spot Open!"}];
                        }
                        gameNames = Object.keys(leaderboards);
                        renderLeaderboard(true); // Initial render
                    });
                });

                function renderLeaderboard(isInitial = false) {
                    if (gameNames.length === 0) return;
                    
                    const game = gameNames[currentIndex];
                    const ranks = leaderboards[game];
                    
                    let ranksHtml = '';
                    ranks.forEach(r => {
                        ranksHtml += `
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 px-2 text-2xl font-orbitron">${r.rank}</td>
                                <td class="py-3 px-2 text-cyan-400 font-bold">${r.name}</td>
                                <td class="py-3 px-2 text-gray-300">${r.achievement}</td>
                            </tr>
                        `;
                    });

                    const newCard = document.createElement('div');
                    newCard.className = 'leaderboard-card';
                    newCard.innerHTML = `
                        <h3 class="text-3xl font-orbitron font-bold text-center mb-4">${game}</h3>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-cyan-400">
                                    <th class="pb-2 w-16">Rank</th>
                                    <th class="pb-2">Player/Team</th>
                                    <th class="pb-2">Achievement</th>
                                </tr>
                            </thead>
                            <tbody>${ranksHtml}</tbody>
                        </table>
                    `;

                    const oldCard = rotator.querySelector('.leaderboard-card');
                    if (oldCard && !isInitial) {
                        oldCard.classList.remove('active');
                        setTimeout(() => {
                            rotator.innerHTML = '';
                            rotator.appendChild(newCard);
                            setTimeout(() => newCard.classList.add('active'), 50);
                        }, 300);
                    } else {
                         rotator.innerHTML = '';
                         rotator.appendChild(newCard);
                         setTimeout(() => newCard.classList.add('active'), 50);
                    }
                }

                prevBtn.addEventListener('click', () => {
                    currentIndex = (currentIndex - 1 + gameNames.length) % gameNames.length;
                    renderLeaderboard();
                });

                nextBtn.addEventListener('click', () => {
                    currentIndex = (currentIndex + 1) % gameNames.length;
                    renderLeaderboard();
                });
            }
            
            async function callGeminiForText(prompt) {
                const apiKey = ""; // Injected by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                     if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        return result.candidates[0].content.parts[0].text;
                    }
                } catch (error) {
                    console.error("Gemini API call error:", error);
                    return null;
                }
                return null;
            }

            main();
            
            // --- Non-Firebase Event Listeners ---
            const suggestionForm = document.getElementById('suggestion-form');
            const suggestionThanks = document.getElementById('suggestion-thanks');
            
            suggestionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = suggestionForm.querySelector('input');
                const text = input.value.trim();
                if (text !== '') {
                    try {
                        const suggestionsCollection = collection(db, `/artifacts/${appId}/public/data/suggestions`);
                        await addDoc(suggestionsCollection, { text: text, createdAt: serverTimestamp() });
                        suggestionThanks.classList.remove('hidden');
                        input.value = '';
                        setTimeout(() => {
                            suggestionThanks.classList.add('hidden');
                        }, 5000);
                    } catch (error) {
                        console.error("Error submitting suggestion:", error);
                        alert("Could not save your suggestion. Please try again.");
                    }
                }
            });

            // --- Arcade Game Logic (Mobile Optimized) ---
            window.onload = () => {
                // --- Space Shooter Game ---
                const shooterCanvas = document.getElementById('spaceShooterCanvas');
                if (shooterCanvas) {
                    const s_ctx = shooterCanvas.getContext('2d');
                    let s_player, s_bullets, s_enemies, s_score, s_gameOver, s_enemyInterval;
                    const s_playerWidth = 20, s_playerHeight = 20;
                    
                    function s_resizeCanvas() {
                        const container = shooterCanvas.parentElement;
                        shooterCanvas.width = container.clientWidth;
                        shooterCanvas.height = container.clientWidth / (16/9);
                    }

                    function s_init() {
                        s_resizeCanvas();
                        s_player = { x: shooterCanvas.width / 2 - s_playerWidth / 2, y: shooterCanvas.height - s_playerHeight - 10, width: s_playerWidth, height: s_playerHeight, speed: 5 };
                        s_bullets = [];
                        s_enemies = [];
                        s_score = 0;
                        s_gameOver = false;
                        if (s_enemyInterval) clearInterval(s_enemyInterval);
                        s_enemyInterval = setInterval(() => {
                            if (!s_gameOver) {
                                const size = 20;
                                const x = Math.random() * (shooterCanvas.width - size);
                                s_enemies.push({ x, y: -size, width: size, height: size, speed: 2 });
                            }
                        }, 1000);
                    }

                    function s_draw() {
                        s_ctx.clearRect(0, 0, shooterCanvas.width, shooterCanvas.height);
                        if (!s_player) return;
                        s_ctx.fillStyle = '#00ff9d';
                        s_ctx.beginPath();
                        s_ctx.moveTo(s_player.x + s_player.width / 2, s_player.y);
                        s_ctx.lineTo(s_player.x, s_player.y + s_player.height);
                        s_ctx.lineTo(s_player.x + s_player.width, s_player.y + s_player.height);
                        s_ctx.closePath();
                        s_ctx.fill();
                        s_ctx.fillStyle = '#ff00ff';
                        s_bullets.forEach(b => s_ctx.fillRect(b.x, b.y, b.width, b.height));
                        s_ctx.fillStyle = '#00f2ff';
                        s_enemies.forEach(e => s_ctx.fillRect(e.x, e.y, e.width, e.height));
                        s_ctx.fillStyle = 'white';
                        s_ctx.font = '20px Orbitron';
                        s_ctx.fillText('Score: ' + s_score, 10, 30);
                        if (s_gameOver) {
                            s_ctx.fillStyle = 'rgba(0,0,0,0.7)';
                            s_ctx.fillRect(0, 0, shooterCanvas.width, shooterCanvas.height);
                            s_ctx.fillStyle = 'red';
                            s_ctx.font = '40px Orbitron';
                            s_ctx.textAlign = 'center';
                            s_ctx.fillText('GAME OVER', shooterCanvas.width / 2, shooterCanvas.height / 2);
                            s_ctx.font = '20px Orbitron';
                            s_ctx.fillText('Tap to Restart', shooterCanvas.width / 2, shooterCanvas.height / 2 + 40);
                        }
                    }

                    function s_update() {
                        if (s_gameOver) return;
                        s_bullets.forEach((b, i) => { b.y -= b.speed; if (b.y < 0) s_bullets.splice(i, 1); });
                        s_enemies.forEach((e, ei) => {
                            e.y += e.speed;
                            if (e.y > shooterCanvas.height) s_enemies.splice(ei, 1);
                            if (s_player && e.x < s_player.x + s_player.width && e.x + e.width > s_player.x && e.y < s_player.y + s_player.height && e.y + e.height > s_player.y) s_gameOver = true;
                            s_bullets.forEach((b, bi) => {
                                if (e.x < b.x + b.width && e.x + e.width > b.x && e.y < b.y + b.height && e.y + e.height > b.y) {
                                    s_enemies.splice(ei, 1);
                                    s_bullets.splice(bi, 1);
                                    s_score += 10;
                                }
                            });
                        });
                    }

                    function s_loop() {
                        s_update();
                        s_draw();
                        requestAnimationFrame(s_loop);
                    }
                    
                    function s_handleMove(e) {
                        if(s_player) {
                            const rect = shooterCanvas.getBoundingClientRect();
                            const clientX = e.clientX || e.touches[0].clientX;
                            s_player.x = clientX - rect.left - s_player.width / 2;
                        }
                    }

                    shooterCanvas.addEventListener('mousemove', s_handleMove);
                    shooterCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); s_handleMove(e); }, { passive: false });

                    shooterCanvas.addEventListener('click', () => {
                        if (s_gameOver) {
                            s_init();
                            return;
                        }
                        if (s_player) s_bullets.push({ x: s_player.x + s_player.width / 2 - 2.5, y: s_player.y, width: 5, height: 10, speed: 7 });
                    });
                    window.addEventListener('resize', s_init);
                    
                    s_init();
                    s_loop();
                }

                // --- Retro Ping Game ---
                const pongCanvas = document.getElementById('pongCanvas');
                if (pongCanvas) {
                    const p_ctx = pongCanvas.getContext('2d');
                    let p_ball, p_playerPaddle, p_computerPaddle, p_playerScore, p_computerScore;
                    const p_paddleWidth = 10, p_paddleHeight = 80;
                    let p_gameActive = false;
                    let p_gameOver = false;
                    const p_winningScore = 6;

                    function p_resizeCanvas() {
                        const container = pongCanvas.parentElement;
                        pongCanvas.width = container.clientWidth;
                        pongCanvas.height = container.clientWidth / (16/9);
                    }

                    function p_init() {
                        p_resizeCanvas();
                        p_playerPaddle = { x: 10, y: pongCanvas.height / 2 - p_paddleHeight / 2, width: p_paddleWidth, height: p_paddleHeight, speed: 8 };
                        p_computerPaddle = { x: pongCanvas.width - 10 - p_paddleWidth, y: pongCanvas.height / 2 - p_paddleHeight / 2, width: p_paddleWidth, height: p_paddleHeight, speed: 4 };
                        p_ball = { x: pongCanvas.width / 2, y: pongCanvas.height / 2, radius: 7, speedX: 5, speedY: 5 };
                        p_playerScore = 0;
                        p_computerScore = 0;
                        p_gameOver = false;
                        p_gameActive = false;
                        p_drawStartScreen();
                    }

                    function p_drawStartScreen() {
                        p_ctx.clearRect(0, 0, pongCanvas.width, pongCanvas.height);
                        p_drawElements();
                        p_ctx.fillStyle = 'rgba(12, 10, 24, 0.7)';
                        p_ctx.fillRect(0, 0, pongCanvas.width, pongCanvas.height);
                        p_ctx.fillStyle = 'white';
                        p_ctx.font = '30px Orbitron';
                        p_ctx.textAlign = 'center';
                        p_ctx.fillText('Tap to Play', pongCanvas.width / 2, pongCanvas.height / 2);
                    }
                    
                    function p_drawGameOverScreen() {
                        p_ctx.fillStyle = 'rgba(12, 10, 24, 0.8)';
                        p_ctx.fillRect(0, 0, pongCanvas.width, pongCanvas.height);
                        p_ctx.fillStyle = 'white';
                        p_ctx.font = '40px Orbitron';
                        p_ctx.textAlign = 'center';
                        const winnerText = p_playerScore >= p_winningScore ? 'You Win!' : 'Computer Wins!';
                        p_ctx.fillText(winnerText, pongCanvas.width / 2, pongCanvas.height / 2 - 20);
                        p_ctx.font = '20px Orbitron';
                        p_ctx.fillText('Tap to Restart', pongCanvas.width / 2, pongCanvas.height / 2 + 30);
                    }

                    function p_drawElements() {
                         if (!p_playerPaddle) return;
                        p_ctx.fillStyle = '#00ff9d';
                        p_ctx.fillRect(p_playerPaddle.x, p_playerPaddle.y, p_playerPaddle.width, p_playerPaddle.height);
                        p_ctx.fillStyle = '#ff00ff';
                        p_ctx.fillRect(p_computerPaddle.x, p_computerPaddle.y, p_computerPaddle.width, p_computerPaddle.height);
                        p_ctx.beginPath();
                        p_ctx.arc(p_ball.x, p_ball.y, p_ball.radius, 0, Math.PI * 2);
                        p_ctx.fillStyle = '#fff';
                        p_ctx.fill();
                        p_ctx.beginPath();
                        p_ctx.setLineDash([10, 15]);
                        p_ctx.moveTo(pongCanvas.width / 2, 0);
                        p_ctx.lineTo(pongCanvas.width / 2, pongCanvas.height);
                        p_ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                        p_ctx.stroke();
                        p_ctx.setLineDash([]);
                        p_ctx.font = '40px Orbitron';
                        p_ctx.fillStyle = '#00ff9d';
                        p_ctx.fillText(p_playerScore, pongCanvas.width / 4, 50);
                        p_ctx.fillStyle = '#ff00ff';
                        p_ctx.fillText(p_computerScore, pongCanvas.width * 3 / 4, 50);
                    }

                    function p_draw() {
                        p_ctx.clearRect(0, 0, pongCanvas.width, pongCanvas.height);
                        p_drawElements();
                        if(p_gameOver) p_drawGameOverScreen();
                    }

                    function p_update() {
                        p_ball.x += p_ball.speedX;
                        p_ball.y += p_ball.speedY;
                        if (p_ball.y + p_ball.radius > pongCanvas.height || p_ball.y - p_ball.radius < 0) p_ball.speedY = -p_ball.speedY;
                        if ((p_ball.x - p_ball.radius < p_playerPaddle.x + p_playerPaddle.width && p_ball.y > p_playerPaddle.y && p_ball.y < p_playerPaddle.y + p_paddleHeight) ||
                            (p_ball.x + p_ball.radius > p_computerPaddle.x && p_ball.y > p_computerPaddle.y && p_ball.y < p_computerPaddle.y + p_paddleHeight)) {
                            p_ball.speedX = -p_ball.speedX;
                        }
                        if (p_ball.x + p_ball.radius < 0) { p_computerScore++; p_resetBall(); } 
                        else if (p_ball.x - p_ball.radius > pongCanvas.width) { p_playerScore++; p_resetBall(); }
                        const paddleCenter = p_computerPaddle.y + p_computerPaddle.height / 2;
                        if (paddleCenter < p_ball.y - 35) p_computerPaddle.y += p_computerPaddle.speed;
                        else if (paddleCenter > p_ball.y + 35) p_computerPaddle.y -= p_computerPaddle.speed;
                    }
                    
                    function p_checkWin() {
                        if (p_playerScore >= p_winningScore || p_computerScore >= p_winningScore) {
                            p_gameActive = false;
                            p_gameOver = true;
                        }
                    }

                    function p_resetBall() {
                        p_checkWin();
                        if (!p_gameOver) {
                            p_ball.x = pongCanvas.width / 2;
                            p_ball.y = pongCanvas.height / 2;
                            p_ball.speedX = -p_ball.speedX;
                            p_ball.speedY = (Math.random() > 0.5 ? 1 : -1) * 5;
                        }
                    }

                    function p_loop() {
                        if (p_gameActive) {
                            p_update();
                        }
                        p_draw();
                        requestAnimationFrame(p_loop);
                    }
                    
                    function p_handleMove(e) {
                         if (p_gameActive && p_playerPaddle) {
                            const rect = pongCanvas.getBoundingClientRect();
                            const clientY = e.clientY || e.touches[0].clientY;
                            p_playerPaddle.y = clientY - rect.top - p_playerPaddle.height / 2;
                            if (p_playerPaddle.y < 0) p_playerPaddle.y = 0;
                            if (p_playerPaddle.y > pongCanvas.height - p_playerPaddle.height) p_playerPaddle.y = pongCanvas.height - p_playerPaddle.height;
                        }
                    }

                    pongCanvas.addEventListener('mousemove', p_handleMove);
                    pongCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); p_handleMove(e); }, { passive: false });

                    const pongStartHandler = (e) => {
                        e.preventDefault();
                        if (p_gameOver) {
                            p_init();
                        }
                        if (!p_gameActive) {
                            p_gameActive = true;
                            pongCanvas.style.cursor = 'none';
                        }
                    };

                    pongCanvas.addEventListener('click', pongStartHandler);
                    pongCanvas.addEventListener('touchstart', pongStartHandler, { passive: false });

                    window.addEventListener('resize', p_init);
                    
                    p_init();
                    p_loop();
                }
            };
        });
    </script>
</body>
</html>
